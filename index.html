<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/png" href="./icon-192.png">

<title>SISTEMA UNICO PREMIUM</title>

<!-- ✅ LOTTIE PLAYER (para .lottie) -->
<script type="module" src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs"></script>

<style>
body{
  font-family:impact;
  background-image: url("./bg.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
  color:blue;
  text-align:center;
  padding:20px;
}

h1{
  color: white;
  letter-spacing: 3px;
  text-shadow:
    0 0 6px #ffffff,
    0 0 12px #1e90ff,
    0 0 20px #1e90ff;
  animation: pulsoTitulo 3s ease-in-out infinite;
}

@keyframes pulsoTitulo{
  0%{
    text-shadow:
      0 0 6px #ffffff,
      0 0 12px #1e90ff,
      0 0 20px #1e90ff;
  }
  50%{
    text-shadow:
      0 0 10px #ffffff,
      0 0 20px #1e90ff,
      0 0 35px #1e90ff;
  }
  100%{
    text-shadow:
      0 0 6px #ffffff,
      0 0 12px #1e90ff,
      0 0 20px #1e90ff;
  }
}

/* ✅ PULSO ACIERTO (4s) */
@keyframes pulsoAcierto{
  0%{
    text-shadow:
      0 0 6px rgba(255,255,255,0.6),
      0 0 10px rgba(0,229,255,0.4);
    transform: scale(1);
  }
  50%{
    text-shadow:
      0 0 12px rgba(255,255,255,1),
      0 0 22px rgba(0,229,255,0.9);
    transform: scale(1.05);
  }
  100%{
    text-shadow:
      0 0 6px rgba(255,255,255,0.6),
      0 0 10px rgba(0,229,255,0.4);
    transform: scale(1);
  }
}

/* OCULTAR TITULOS EXPLOSIVOS Y REPUESTO */
#explosivosTitle,
#repuestoTitle{
  display:none !important;
}

/* Capa oscura para mejorar lectura */
body::before{
  content:"";
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background: rgba(0,0,0,0.65);
  z-index:-1;
}
.hidden{display:none;}

.inputs{display:grid;gap:10px;justify-content:center;}
.inputs input{
  width:70px;
  height:70px;
  font-size:34px;
  font-weight:bold;

  background:#000000;
  border:3px solid #000000;

  color:#ffffff;
  text-align:center;
}

/* ✅ Layout ingreso */
.ingreso{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:15px;
  justify-content:center;
  align-items:start;
  width: fit-content;
  margin: 0 auto;
}

.ingresoCol{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
}

.ingresoInput{
  width:80px;
  height:80px;
  font-size:36px;
  font-weight:bold;

  background-image: url("./bg-casino-green.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  border-radius:8px;

  color:#00ff88;
  text-align:center;

  text-shadow: 0 0 6px #00ff88;

  outline:none;
}

.label{margin-top:0;font-weight:bold;}

/* TOTAL */
.totalBox{
  width:120px;
  height:77px;
  font-size:28px;
  font-weight:bold;

  background-image: url("./btn-neon-cian.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  color:#ffffff;

  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
  padding:0;

  border-radius:10px;

  text-shadow: 0 2px 6px rgba(0,0,0,0.8);
}
.totalLabel{margin-top:0;font-weight:bold;color:#0b8f3a;}

/* GANANCIA */
.gananciaBox{
  width:120px;
  height:77px;
  font-size:28px;
  font-weight:bold;

  background-image: url("./btn-neon-gold.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  color:#ffffff;

  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
  padding:0;

  border-radius:10px;

  text-shadow: 0 2px 6px rgba(0,0,0,0.85);
}
.gananciaLabel{margin-top:0;font-weight:bold;color:#ffd400;}

/* ✅ ACIERTO debajo de GANANCIA */
.aciertoWrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  margin-top:6px;
}
.aciertoBox{
  width:80px;
  height:80px;
  font-size:46px;
  font-weight:bold;

  background-image: url("./bg-acierto-blue.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  color:#ffffff;

  display:none;
  align-items:center;
  justify-content:center;

  border-radius:10px;

  text-shadow: 0 0 8px #00e5ff;

  animation: pulsoAcierto 4s ease-in-out infinite;
}
.aciertoLabel{margin-top:0;font-weight:bold;color:#0b57ff;display:none;}

.box{
  width:260px;min-height:60px;margin:10px auto;border:6px solid #444;
  font-weight:bold;padding:5px;
}

/* EXPLOSIVOS */
.explosivos{
  background: #0b1a2a;
  color: #ffffff;
  font-size: 48px;
  font-weight: bold;

  padding: 16px;
  border-radius: 8px;

  border: 3px solid #c9a24d;

  box-shadow:
    0 0 4px rgba(0,0,0,0.8),
    0 2px 6px rgba(0,0,0,0.9);

  text-shadow:
    0 1px 2px rgba(0,0,0,0.9);
}
.explosivos.warnRepeats{ background:red !important; }
.explosivos.warnTriples{ background:#0b57ff !important; }

/* REPUESTO */
.repuesto{
  background: #2b0f14;
  color: #ffffff;
  font-size: 48px;
  font-weight: bold;

  padding: 16px;
  border-radius: 8px;

  border: 3px solid #c9a24d;

  box-shadow:
    0 0 4px rgba(0,0,0,0.8),
    0 2px 6px rgba(0,0,0,0.9);

  text-shadow:
    0 1px 2px rgba(0,0,0,0.9);
}
.repuestoTitle{color:#ff00ff;margin-top:10px;display:none;}

button{padding:10px;background:maroon;color:white;font-weight:bold;border:none;border-radius:8px;}

.abcWrap{display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap;}
.abc{
  width:80px;
  height:80px;
  font-size:36px;
  font-weight:bold;

  background-image: url("ficha-verde.png");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  border:none;
  color:#000;

  display:none;
  align-items:center;
  justify-content:center;

  border-radius:8px;

  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* LOGIN + ADMIN */
.loginBox{
  display:inline-block;
  padding:14px 16px;
  border:2px solid #444;
  border-radius:10px;
}
.loginRow{margin:8px 0;}
.loginInput{
  width:220px;height:36px;font-size:18px;padding:6px 10px;
  border:2px solid #444;background:#111;color:#fff;border-radius:8px;
}

.adminPanel{
  width:340px;margin:18px auto 0;border:2px solid #444;border-radius:10px;
  padding:12px;text-align:left;
}
.adminTitle{font-weight:bold;margin-bottom:10px;}
.adminGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.adminGrid input{
  width:100%;height:34px;font-size:16px;padding:4px 8px;
  border:2px solid #444;background:#111;color:#fff;border-radius:8px;
}
.adminBtns{display:flex;gap:8px;margin-top:10px;}
.adminBtns button{flex:1;padding:10px 0;}
.adminOut{margin-top:10px;font-size:14px;color:#ddd;word-break:break-word;line-height:1.35;}
.smallNote{margin-top:6px;font-size:12px;color:#aaa;}

/* SALIR */
.logoutBtn{
  margin-top:14px;
  padding:8px 14px;
  background:#222;
  color:#fff;
  border:2px solid #444;
  border-radius:10px;
  font-weight:bold;
}

/* ✅ SPLASH FULLSCREEN 4s */
#splash{
  position:fixed;
  inset:0;
  z-index:99999;
  background:#000;
  background-image:url("./splash.png");
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
}
#appContent{
  display:none;
}

/* ✅ BLOQUEO OFFLINE (100% online) */
#offlineWall{
  position:fixed;
  inset:0;
  z-index:99998;
  display:none;
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,0.92);
  padding:20px;
}
.offlineCard{
  width:min(420px, 92vw);
  border:2px solid #444;
  border-radius:14px;
  background: rgba(15,15,15,0.85);
  padding:18px 16px;
  color:#fff;
  text-align:center;
}
.offlineTitle{
  font-size:18px;
  font-weight:bold;
  margin-bottom:8px;
}
.offlineText{
  font-size:14px;
  color:#ddd;
  line-height:1.35;
  margin-bottom:12px;
}
.offlineBtn{
  padding:10px 14px;
  background:#111;
  border:2px solid #444;
  border-radius:12px;
  color:#fff;
  font-weight:bold;
}

/* ✅ EFECTO ACIERTO (LOTTIE ARRIBA DEL BOTÓN) */
#winFx{
  width:100%;
  display:none;
  justify-content:center;
  align-items:center;
  margin-top:6px;
  margin-bottom:2px;
}
#winPlayer{
  width: 300px;
  height: 300px;
}
</style>
</head>

<body>

<!-- ✅ SPLASH -->
<div id="splash"></div>

<!-- ✅ OFFLINE WALL -->
<div id="offlineWall">
  <div class="offlineCard">
    <div class="offlineTitle">REQUIERE CONEXIÓN A INTERNET</div>
    <div class="offlineText">
      Para usar el sistema necesitás estar online.<br>
      Conectate y tocá “Reintentar”.
    </div>
    <button class="offlineBtn" onclick="location.reload()">REINTENTAR</button>
  </div>
</div>

<!-- ✅ TODO TU SISTEMA ADENTRO -->
<div id="appContent">

<h1>SISTEMA UNICO PREMIUM</h1>

<div id="login" class="loginBox">
  <div class="loginRow"><input id="usuario" class="loginInput" placeholder="Usuario"></div>
  <div class="loginRow"><input id="clave" class="loginInput" placeholder="Clave" type="password"></div>
  <div class="loginRow"><button onclick="ingresar()">INGRESAR</button></div>
  <p id="err" style="color:red;margin:6px 0 0;"></p>
</div>

<div id="sistema" class="hidden">

  <div class="inputs" id="casilleros"></div>

  <br>

  <div class="ingreso">
    <div class="ingresoCol">
      <input id="nuevo" class="ingresoInput">
      <div class="label" style="color:#00ff88; text-shadow:0 0 6px #00ff88;">INGRESO</div>
    </div>

    <div class="ingresoCol">
      <div id="totalFichas" class="totalBox">0</div>
      <div class="totalLabel" style="color:#00e5ff; text-shadow:0 0 6px #00e5ff;">TOTAL</div>
    </div>

    <div class="ingresoCol">
      <div id="gananciaBox" class="gananciaBox">0</div>
      <div class="gananciaLabel" style="color:#ffd700; text-shadow:0 0 6px #ffd700;">GANANCIA</div>

      <div class="aciertoWrap">
        <div id="aciertoBox" class="aciertoBox">0</div>
        <div id="aciertoLabel" class="aciertoLabel" style="color:#00e5ff; text-shadow:0 0 6px #00e5ff;">ACIERTO</div>
      </div>
    </div>
  </div>

  <!-- ✅ EFECTO ACIERTO (AHORA VA ACÁ: ARRIBA DEL REINICIAR) -->
  <div id="winFx">
    <dotlottie-player
      id="winPlayer"
      src="./success-cav.lottie"
      background="transparent"
      speed="1"
      loop="false"
      autoplay="false">
    </dotlottie-player>
  </div>

  <div style="margin-top:12px;">
    <button onclick="resetear()">REINICIAR</button>
  </div>

  <h3 id="explosivosTitle" style="color:black">EXPLOSIVOS</h3>
  <div id="explosivos" class="box explosivos">—</div>

  <h3 id="repuestoTitle" class="repuestoTitle">REPUESTO</h3>
  <div id="repuesto" class="box repuesto">—</div>

  <div class="abcWrap">
    <div id="A" class="abc"></div><div id="B" class="abc"></div><div id="C" class="abc"></div><div id="D" class="abc"></div><div id="E" class="abc"></div>
    <div id="F" class="abc"></div><div id="G" class="abc"></div><div id="H" class="abc"></div><div id="I" class="abc"></div><div id="J" class="abc"></div>
    <div id="K" class="abc"></div><div id="L" class="abc"></div><div id="M" class="abc"></div><div id="N" class="abc"></div><div id="O" class="abc"></div>
    <div id="P" class="abc"></div><div id="Q" class="abc"></div><div id="R" class="abc"></div><div id="S" class="abc"></div><div id="T" class="abc"></div>

    <!-- ✅ +20 nuevas letras: U..AO -->
    <div id="U" class="abc"></div><div id="V" class="abc"></div><div id="W" class="abc"></div><div id="X" class="abc"></div><div id="Y" class="abc"></div>
    <div id="Z" class="abc"></div><div id="AB" class="abc"></div><div id="AC" class="abc"></div><div id="AD" class="abc"></div><div id="AE" class="abc"></div>
    <div id="AF" class="abc"></div><div id="AG" class="abc"></div><div id="AH" class="abc"></div><div id="AI" class="abc"></div><div id="AJ" class="abc"></div>
    <div id="AK" class="abc"></div><div id="AL" class="abc"></div><div id="AM" class="abc"></div><div id="AN" class="abc"></div><div id="AO" class="abc"></div>
  </div>

  <div id="adminPanel" class="adminPanel hidden">
    <div class="adminTitle">CREAR USUARIO (CON VENCIMIENTO)</div>

    <div class="adminGrid">
      <input id="newUser" placeholder="Usuario">
      <input id="newPass" placeholder="Clave">
    </div>

    <div class="adminBtns">
      <button onclick="crearUsuario(1)">1 DÍA</button>
      <button onclick="crearUsuario(7)">7 DÍAS</button>
      <button onclick="crearUsuario(30)">30 DÍAS</button>
    </div>

    <div id="adminOut" class="adminOut"></div>
    <div class="smallNote">Se guarda en el servidor (backend).</div>
  </div>

  <button class="logoutBtn" onclick="salir()">SALIR</button>
  <button class="logoutBtn" onclick="resetApp2()">RESET APP2</button>
</div>

</div><!-- fin appContent -->

<script>
const API = "https://s77-backend2.onrender.com";

// ✅ Keys únicas para s77-app2 (evita que choque con tu otro frontend)
const TOKEN_KEY = "S77_APP2_TOKEN_V1";
const ROLE_KEY  = "S77_APP2_ROLE_V1";

let TOKEN = localStorage.getItem(TOKEN_KEY) || "";
let ROLE  = localStorage.getItem(ROLE_KEY) || "";

// ✅ Registrar Service Worker con path correcto para GitHub Pages
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/s77-app2/sw.js");
}

/* ✅ Offline wall helpers */
let booted = false;
function setOfflineWall(){
  const wall = document.getElementById("offlineWall");
  const online = navigator.onLine;

  if(!wall) return;
  wall.style.display = online ? "none" : "flex";

  if(!online){
    try{ renderAcierto(false, 0); }catch(e){}
  }
}

/* ✅ LOTTIE WIN FX (AHORA NO ES OVERLAY, ES ARRIBA DEL BOTÓN) */
let winFxTimer = null;
function showWinFx(ms = 1200){
  const fx = document.getElementById("winFx");
  const player = document.getElementById("winPlayer");
  if(!fx || !player) return;

  fx.style.display = "flex";

  try{
    player.stop();
    player.play();
  }catch(e){}

  clearTimeout(winFxTimer);
  winFxTimer = setTimeout(() => {
    fx.style.display = "none";
  }, ms);
}

/* GANANCIA */
const GANANCIA_KEY = "S77_APP2_GANANCIA_V1";
let gananciaAcum = Number(localStorage.getItem(GANANCIA_KEY) || 0);
if (!Number.isFinite(gananciaAcum)) gananciaAcum = 0;

function setGanancia(v){
  const n = Number(v);
  gananciaAcum = Number.isFinite(n) ? n : 0;
  gananciaBox.textContent = String(Math.round(gananciaAcum));
  localStorage.setItem(GANANCIA_KEY, String(gananciaAcum));
}
setGanancia(gananciaAcum);

function renderAcierto(show, value){
  const box = document.getElementById("aciertoBox");
  const lab = document.getElementById("aciertoLabel");
  if(!box || !lab) return;

  if(show){
    box.style.display = "flex";
    lab.style.display = "block";
    box.textContent = String(Math.round(Number(value)||0));
  }else{
    box.style.display = "none";
    lab.style.display = "none";
    box.textContent = "0";
  }
}
function sumarGananciaDesdeAcierto(value){
  const n = Number(value);
  if(!Number.isFinite(n)) return;
  setGanancia(gananciaAcum + n);
}
function setTotalFichas(v){
  const n = Number(v);
  totalFichas.textContent = Number.isFinite(n) ? String(Math.round(n)) : "0";
}

/* WARN */
function getWarnModeFromData(data){
  if(data && typeof data.warnMode === "string") return data.warnMode;
  if(data && data.warnRepeats) return "red";
  return "none";
}

/* SUSPENSIÓN UI */
function aplicarSuspensionUI(active){
  const expTitle = document.getElementById("explosivosTitle");
  const repTitle = document.getElementById("repuestoTitle");
  const repBox   = document.getElementById("repuesto");

  if(active){
    if(expTitle) expTitle.style.display = "none";
    explosivos.style.display = "none";
    if(repTitle) repTitle.style.display = "none";
    if(repBox){ repBox.style.display = "none"; repBox.textContent = "—"; }
    renderAcierto(false, 0);
  }
}

/* ✅ CAMBIO: SOLO UN CASILLERO VISIBLE A LA VEZ */
function aplicarWarnMode(mode){
  const m = mode || "none";

  explosivos.classList.remove("warnRepeats","warnTriples");
  if(m === "red") explosivos.classList.add("warnRepeats");
  if(m === "blue") explosivos.classList.add("warnTriples");

  const expBox = document.getElementById("explosivos");
  const repBox = document.getElementById("repuesto");

  if(!expBox || !repBox) return;

  if(m === "none"){
    expBox.style.display = "block";
    repBox.style.display = "none";
    repBox.textContent = "—";
  }else if(m === "red"){
    expBox.style.display = "none";
    repBox.style.display = "block";
  }else{
    expBox.style.display = "none";
    repBox.style.display = "none";
    repBox.textContent = "—";
  }
}

function renderRepuesto(arr, mode, suspensionActive){
  const box = document.getElementById("repuesto");
  if(!box) return;

  if(suspensionActive || mode === "blue" || mode === "none"){
    box.style.display = "none";
    box.textContent = "—";
    return;
  }

  const cleanArr = Array.isArray(arr) ? arr : [];
  const show = (mode === "red") && cleanArr.length;

  if(show){
    box.style.display = "block";
    box.textContent = cleanArr.join(" ");
  }else{
    box.style.display = "none";
    box.textContent = "—";
  }
}

/* =========================
   COLORES POR NÚMERO
========================= */
const NUM_BG = {
  0:"#0b7a3b", 1:"#ff0000", 2:"#000000", 3:"#ff0000", 4:"#000000", 5:"#ff0000",
  6:"#000000", 7:"#ff0000", 8:"#000000", 9:"#ff0000", 10:"#000000", 11:"#000000",
  12:"#ff0000", 13:"#000000", 14:"#ff0000", 15:"#000000", 16:"#ff0000", 17:"#000000",
  18:"#ff0000", 19:"#ff0000", 20:"#000000", 21:"#ff0000", 22:"#000000", 23:"#ff0000",
  24:"#000000", 25:"#ff0000", 26:"#000000", 27:"#ff0000", 28:"#000000", 29:"#000000",
  30:"#ff0000", 31:"#000000", 32:"#ff0000", 33:"#000000", 34:"#ff0000", 35:"#000000",
  36:"#ff0000",
};

function pintarCasilleroPorNumero(inputEl){
  const v = parseInt(inputEl.value, 10);
  inputEl.style.background = Number.isFinite(v) ? (NUM_BG[v] || "#000") : "#000";
  inputEl.style.color = "#fff";
  inputEl.style.borderColor = "#000";
}

/* =========================
   Validación
========================= */
function validarNumero(n){
  if(!Number.isInteger(n)) return { ok:false, msg:"Tenés que ingresar un número entero." };
  if(n < 0 || n > 36) return { ok:false, msg:"Solo se permiten números del 0 al 36." };
  return { ok:true, msg:"" };
}

/* PAUSA A..T */
let conteoPausado = false;
let cacheActiveId = "A";
let cacheActiveMult = 1;
let cacheInicializado = false;

/* ✅ FIX: ahora oculta TODAS las letras que existan en .abcWrap
   (así no dependés de A..T y soporta U..AO y futuras letras sin tocar nada más) */
function ocultarAT(){
  const wrap = document.querySelector(".abcWrap");
  if(!wrap) return;
  wrap.querySelectorAll(".abc").forEach(el=>{
    el.style.display = "none";
    el.textContent = "";
  });
}

function mostrarAT(id, mult){
  ocultarAT();
  const elActive = document.getElementById(id);
  if (elActive) {
    elActive.style.display = "flex";
    elActive.textContent = String(mult);
  }
}
function aplicarConteoDesdeBackend(activeId, activeMult){
  cacheInicializado = true;
  cacheActiveId = activeId || "A";
  cacheActiveMult = Number(activeMult) || 1;
  mostrarAT(cacheActiveId, cacheActiveMult);
}
function syncPausaConteoConColor(){
  conteoPausado =
    explosivos.classList.contains("warnRepeats") ||
    explosivos.classList.contains("warnTriples");
}

/* ADMIN */
async function crearUsuario(dias){
  if(ROLE !== "admin"){
    adminOut.innerHTML = "Solo admin puede crear usuarios.";
    return;
  }
  const u=(newUser.value||"").trim();
  const p=(newPass.value||"").trim();
  if(!u || !p){
    adminOut.innerHTML = "Falta <b>Usuario</b> y/o <b>Clave</b>.";
    return;
  }
  try{
    const r = await fetch(`${API}/admin/create-user`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization": `Bearer ${TOKEN}`
      },
      body: JSON.stringify({ user:u, pass:p, days:dias })
    });

    const data = await r.json();
    if(!r.ok){
      adminOut.innerHTML = "Error creando usuario (¿token inválido o no sos admin?)";
      return;
    }
    const expDate = new Date(data.exp).toLocaleString();
    adminOut.innerHTML =
      `✅ Creado/actualizado:<br>`+
      `<b>Usuario:</b> ${data.user}<br>`+
      `<b>Clave:</b> ${p}<br>`+
      `<b>Vence:</b> ${expDate} (${dias} día${dias===1?"":"s"})`;
  }catch(e){
    adminOut.innerHTML = "No conecta con el servidor. ¿Está prendido el backend?";
  }
}

/* Mostrar/ocultar login */
function mostrarLogin(){
  login.classList.remove("hidden");
  login.style.display = "inline-block";
  sistema.classList.add("hidden");
  sistema.style.display = "none";
}
function mostrarSistema(){
  login.classList.add("hidden");
  login.style.display = "none";
  sistema.classList.remove("hidden");
  sistema.style.display = "block";
  if(ROLE === "admin") adminPanel.classList.remove("hidden");
  else adminPanel.classList.add("hidden");
}

/* LOGIN */
async function ingresar(){
  if(!navigator.onLine){ setOfflineWall(); return; }

  const u=(usuario.value||"").trim();
  const p=(clave.value||"").trim();
  if(!u || !p){ err.innerText="Completa usuario y clave"; return; }

  try{
    const r = await fetch(`${API}/auth/login`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user:u, pass:p })
    });

    const data = await r.json();
    if(!r.ok){
      err.innerText="Usuario/clave inválidos o vencidos";
      return;
    }

    TOKEN = data.token;
    ROLE = data.role;

    localStorage.setItem(TOKEN_KEY, TOKEN);
    localStorage.setItem(ROLE_KEY, ROLE);

    err.innerText="";
    mostrarSistema();
    await cargarEstado();
  }catch(e){
    err.innerText="No conecta con el servidor. ¿Está prendido el backend?";
  }
}

/* SALIR */
function salir(){
  if(!confirm("¿Seguro querés salir?")) return;

  TOKEN = "";
  ROLE = "";

  // ✅ Limpia las keys de s77-app2
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(ROLE_KEY);

  // ✅ (recomendado) Limpia keys viejas por si antes estaba compartido con el otro frontend
  localStorage.removeItem("S77_TOKEN_V1");
  localStorage.removeItem("S77_ROLE_V1");

  // ✅ (opcional) Fuerza actualización del SW si hay uno nuevo esperando
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: "SKIP_WAITING" });
  }

  mostrarLogin();
}

// ✅ RESET TOTAL SOLO APP2 (storage + caches)
async function resetApp2(){
  if(!confirm("Esto reiniciará completamente S77 APP2. ¿Continuar?")) return;

  try{
    // ✅ borrar storage exclusivo de app2
    localStorage.removeItem("S77_APP2_TOKEN_V1");
    localStorage.removeItem("S77_APP2_ROLE_V1");
    localStorage.removeItem("S77_APP2_GANANCIA_V1");

    // ✅ por las dudas, limpiar restos viejos
    localStorage.removeItem("S77_TOKEN_V1");
    localStorage.removeItem("S77_ROLE_V1");
    localStorage.removeItem("S77_GANANCIA_V1");

    // ✅ borrar caches exclusivos de app2
    if("caches" in window){
      const keys = await caches.keys();
      for(const key of keys){
        if(key.startsWith("s77-app2")){
          await caches.delete(key);
        }
      }
    }

    // ✅ reset variables en memoria
    TOKEN = "";
    ROLE  = "";
    gananciaAcum = 0;

    alert("S77 APP2 fue reiniciado correctamente");
    location.reload();

  }catch(e){
    alert("Error al reiniciar: " + e.message);
  }
}

/* Render inicial */
function renderInicial(){
  casilleros.innerHTML="";
  casilleros.style.gridTemplateColumns="repeat(4,70px)";
  for(let i=0;i<16;i++){
    let c=document.createElement("input");
    c.disabled=true;
    c.value = "";
    pintarCasilleroPorNumero(c);
    casilleros.appendChild(c);
  }
}

async function cargarEstado(){
  if(!navigator.onLine){ setOfflineWall(); return; }

  try{
    const r = await fetch(`${API}/api/state`,{
      method:"GET",
      headers:{ "Authorization": `Bearer ${TOKEN}` }
    });

    const data = await r.json();
    if(!r.ok){ salir(); return; }

    casilleros.innerHTML="";

    if(data.historialLen < 17){
      casilleros.style.gridTemplateColumns="repeat(4,70px)";
      data.ultimos16.forEach(v=>{
        const c=document.createElement("input");
        c.disabled=true;
        c.value=v;
        pintarCasilleroPorNumero(c);
        casilleros.appendChild(c);
      });
      if(data.historialLen===0) renderInicial();
    }else{
      casilleros.style.gridTemplateColumns="repeat(5,70px)";
      data.ultimos5.forEach(v=>{
        const c=document.createElement("input");
        c.disabled=true;
        c.value=v;
        pintarCasilleroPorNumero(c);
        casilleros.appendChild(c);
      });
    }

    const suspensionActive = !!data.suspensionActive;

    explosivos.innerText = (data.explosivos && data.explosivos.length)
      ? data.explosivos.join(" ")
      : "—";

    const mode = getWarnModeFromData(data);

    if(suspensionActive){
      aplicarSuspensionUI(true);
    }else{
      aplicarWarnMode(mode);
    }

    syncPausaConteoConColor();
    renderRepuesto(data.repuesto, mode, suspensionActive);

    setTotalFichas(data.fichasTotal);
    aplicarConteoDesdeBackend(data.activeId, data.activeMult);
    renderAcierto(false, 0);

  }catch(e){}
}

async function resetear(){
  if(!navigator.onLine){ setOfflineWall(); return; }

  if(!TOKEN){ alert("Tenés que estar logueado."); return; }
  if(!confirm("¿Seguro querés reiniciar tu historial?")) return;

  try{
    const r = await fetch(`${API}/api/reset`,{
      method:"POST",
      headers:{ "Authorization": `Bearer ${TOKEN}` }
    });

    if(!r.ok){ alert("No se pudo reiniciar."); return; }

    aplicarWarnMode("none");
    syncPausaConteoConColor();
    setTotalFichas(0);
    renderRepuesto([], "none", false);
    renderAcierto(false, 0);
    setGanancia(0);

    // ✅ ocultar fx si estaba visible
    const fx = document.getElementById("winFx");
    if(fx) fx.style.display = "none";

    await cargarEstado();
  }catch(e){
    alert("No conecta con el backend.");
  }
}

/* ENTER */
nuevo.addEventListener("keydown", async (e) => {
  if (e.key !== "Enter") return;

  if(!navigator.onLine){ setOfflineWall(); return; }

  if(!TOKEN){
    alert("Primero tenés que ingresar con usuario y clave.");
    return;
  }

  const n = parseInt(nuevo.value, 10);
  const v = validarNumero(n);
  if(!v.ok){ alert(v.msg); return; }

  nuevo.value = "";

  try {
    const r = await fetch(`${API}/api/enter`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${TOKEN}`
      },
      body: JSON.stringify({ n })
    });

    const data = await r.json();
    if (!r.ok) { salir(); return; }

    casilleros.innerHTML = "";

    if (data.historialLen < 17) {
      casilleros.style.gridTemplateColumns = "repeat(4,70px)";
      data.ultimos16.forEach(v => {
        const c = document.createElement("input");
        c.disabled = true;
        c.value = v;
        pintarCasilleroPorNumero(c);
        casilleros.appendChild(c);
      });
      if(data.historialLen === 0) renderInicial();
    } else {
      casilleros.style.gridTemplateColumns = "repeat(5,70px)";
      data.ultimos5.forEach(v => {
        const c = document.createElement("input");
        c.disabled = true;
        c.value = v;
        pintarCasilleroPorNumero(c);
        casilleros.appendChild(c);
      });
    }

    const suspensionActive = !!data.suspensionActive;

    explosivos.innerText = (data.explosivos && data.explosivos.length)
      ? data.explosivos.join(" ")
      : "—";

    const mode = getWarnModeFromData(data);

    if(suspensionActive){
      aplicarSuspensionUI(true);
    }else{
      aplicarWarnMode(mode);
    }

    syncPausaConteoConColor();
    renderRepuesto(data.repuesto, mode, suspensionActive);

    setTotalFichas(data.fichasTotal);
    aplicarConteoDesdeBackend(data.activeId, data.activeMult);

    if(suspensionActive){
      renderAcierto(false, 0);
      return;
    }

    const show = !!data.aciertoShow;
    const val  = Number(data.aciertoValue);

    renderAcierto(show, val);
    if(show){
      sumarGananciaDesdeAcierto(val);
      showWinFx(1200); // ✅ EXPLOSIÓN DORADA (arriba del botón)
    }

  } catch (err) {
    alert("No conecta con el backend. ¿Está prendido?");
  }
});

/* ✅ Boot (online only) */
async function boot(){
  if(booted) return;
  if(!navigator.onLine){ setOfflineWall(); return; }

  booted = true;

  if(TOKEN){
    mostrarSistema();
    await cargarEstado();
  }else{
    mostrarLogin();
  }
}

/* ✅ Splash + Online gate */
(async function init(){

  const splash = document.getElementById("splash");
  const app = document.getElementById("appContent");

  setTimeout(() => {
    if(splash) splash.style.display = "none";
    if(app) app.style.display = "block";
    setOfflineWall();
  }, 4000);

  setOfflineWall();
  await boot();

  window.addEventListener("offline", () => {
    setOfflineWall();
  });
  window.addEventListener("online", async () => {
    setOfflineWall();
    if(!booted){
      await boot();
    }else if(TOKEN){
      await cargarEstado();
    }
  });

})();
</script>

</body>
</html>
